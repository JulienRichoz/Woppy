---------------------------------------------------------------------------------------------------------------
--Titre: 1.6main.lua
--Date: 25.05.2016
--Version 1.6
--Auteur: Richoz Julien
--Description v. 1.6: Gestion des stacks
--Améliorations: revue des passages de phase, gestion des stacks, fonctions pour récuperer debuff, création timer

--Versions antérieures: 
--		v. 1.0: "lancer" l'addon lorsque l'on entre dans le bon raid
--		v. 1.1:	Détection combat contre le boss
--		v. 1.2: Gestion des rôles et spécialisations
--		v. 1.3: Gestion des alertes sonores et visuelles
--		v. 1.4.1: Gestion des sorts 
--		v. 1.4.2: Gestion des sorts plus poussées
--		v. 1.5: Gestion des lancement de sorts d'Immerseus
---------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------

----------------------------------------DECLARATION CAPTURE EVENEMENT--------------------------------------------
--capturer zone
local areaFrame = CreateFrame("Frame");
areaFrame:RegisterEvent("PLAYER_ENTERING_WORLD"); --event fire au moment de la conenction dans le jeu
areaFrame:RegisterEvent("ZONE_CHANGED_INDOOR"); --event fire quand le personnage entre dans une instance 

--capturer boss combat. Frame similaire créée au dessus mais celle-ci sera un OnUpdate et nous devrons la cacher après son utilsiation
local inCombatFrame = CreateFrame("Frame");
inCombatFrame:RegisterEvent("INSTANCE_ENCOUNTER_ENGAGE_UNIT");

--Frame pour capturer les sorts que le boss lance
local immerseusFrame = CreateFrame("Frame");
immerseusFrame:RegisterEvent("COMBAT_LOG_EVENT_UNFILTERED");
immerseusFrame:RegisterEvent("PLAYER_REGEN_ENABLED");
immerseusFrame:RegisterEvent("SPELL_CAST_START");
immerseusFrame:RegisterEvent("SPELL_AURA_APPLIED");
immerseusFrame:RegisterEvent("SPELL_CAST_SUCCESS");
immerseusFrame:RegisterEvent("SPELL_AURA");
immerseusFrame:RegisterEvent("CHAT_MSG_RAID_BOSS_EMOTE");

-----------------------------------------DECLARATION VARIABLES LOCALES----------------------------------------------
woppy_spec = nil; --contient les informations sur la spécialisation actuelle
woppy_specName = nil; --contient le nom de notre spécialsiation
woppy_specId = nil; --contient l'id de notre spécialsiation
woppy_specRole = nil; --role de notre specialisation

woppy_flag=0; --definit si une frame a déjà été lancée ou non
woppy_flagVieBoss=0; --evite de spamemr un message d'alerte
woppy_flagStack=0;
woppy_phase = 1; --evite le calcul de la vie du boss quand il est "mort" et cause erreurs
woppy_test = 1;

woppy_unitImmerseus=nil;
woppy_vieBoss=nil;
woppy_corruptionBoss=nil;

--3.1 Fonction pour retourner vie boss (auteur: Waverian, code récupéré et modifié sur http://www.wowinterface.com/forums/showthread.php?t=32350)
--Très difficile de retourner la vie du boss via l'ID du boss. Seul moyen abordable est par le target -> on scan l'ensemble du raid qui l'a en target si jamais nous ne l'avons pas et analysons la vie du boss
local IMMERSEUS="Immerseus";
local ScanForUnit = function(name)
	local nbJoueur=GetNumGroupMembers();
	if(nbJoueur>1) then 
		if(UnitName("target")== name) then
			return "target";
		elseif (UnitName("focus") == name) then
			return "focus";
		elseif (UnitName("pettarget")== name) then
			return "pettarget";
		else
			for i = 1, nbJoueur do
				local unit = ("raid%dtarget"):format(i);
				if (UnitName(unit) == name) then 
					return unit ;
				end
			end
		end
	end
	--Si on est seul
	if(nbJoueur==0) then 
		if(UnitName("target")==name) then
			return "target";
		end		
	end
end

--3.2 Fonction pour récuprer debuff stack explosion caustique
local ScanForDebuff = function(idDebuff)
	local nbJoueur=GetNumGroupMembers();
	local playerUnit=UnitName("player");
	--Si groupe de raid
	if(nbJoueur>1) then
		for i = 1, nbJoueur do
			local unit = ("raid%d"):format(i);
			for i=1,5 do 
				local name, rank, icon, count, dispelType, duration, expires, caster, isStealable, shouldConsolidate, spellID= UnitDebuff(unit ,i);
				if(spellID==idDebuff) then 
					if(unit~=playerUnit) then
						return RaidNotice_AddMessage(RaidWarningFrame, "Reprenez l'aggro du boss!", ChatTypeInfo["RAID_WARNING"]);
					end
				end
			end
		end
	end
	--Si seul
	if(nbJoueur==0) then
		return;
	end
end
	
-----3.3 Fonction stratégie phase 2
local phase2 = function(role)
	if(role=="TANK" or role=="DAMAGER") then
		return RaidNotice_AddMessage(RaidWarningFrame, "DPS GLOBULES NOIRES", ChatTypeInfo["RAID_WARNING"]);
	elseif(role=="HEALER") then
		return RaidNotice_AddMessage(RaidWarningFrame, "HEAL GLOBULES VERTES", ChatTypeInfo["RAID_WARNING"]);
	end
end
----------------------------3) FONCTION STRAT IMMERSEUS---------------------------------------------------------
local function StratImmerseus()
	--Sorts du boss
	local explosionCaustique = GetSpellInfo(143436);
	local shaSuitant = GetSpellInfo(143286);
	local tourbillon = GetSpellInfo(143309);
	local scission = GetSpellInfo(143020);
	local projectionSha = GetSpellInfo(143298);
	print("Strat Immerseus dedans-debut");
	
	immerseusFrame:SetScript("OnEvent", function(self, event, ...)
		if(event=="COMBAT_LOG_EVENT_UNFILTERED") then 
			local timestamp,event,hideCaster,sourceGUID,sourceName,sourceFlags,sourceFlags2,destGUID,destName,destFlags,destFlags2,spellID,spellName= select ( 1 , ... ); --recupère diverses infos à chaque event évènement (notamment sorts lancé)
			--scan des unités ciblants immerseus pour récuperer ses pdv et ses ressources (corruption)	
		--	if(woppy_phase==1) then --seulement en phase car génère erreur en P2
				woppy_unitImmerseus = ScanForUnit(IMMERSEUS);
				woppy_vieBoss = UnitHealth(woppy_unitImmerseus)/UnitHealthMax(woppy_unitImmerseus)*100;
				woppy_corruptionBoss = UnitPower(woppy_unitImmerseus);
		--	end
			--Si la vie du boss est inférieure à 3%, message d'alerte pour se disperser car passage en P2
			if(woppy_vieBoss<7 and woppy_flagVieBoss==0) then 
				woppy_flagVieBoss=1; --evite de spammer le message
				RaidNotice_AddMessage(RaidWarningFrame, "!PREPAREZ VOUS A VOUS DISPERSEZ VOUS POUR LA P2!", ChatTypeInfo["RAID_WARNING"]);
				--woppy_phase=2;
				--phase2(woppy_specRole);
			end	
			--Passage en P2
			if(woppy_vieBoss<=1.5 and woppy_flagVieBoss==1) then
				woppy_flagVieBoss=2 --evite de spammer message
				print("phase2");
				woppy_phase=2;
				phase2(woppy_specRole);
			end
			--Passage en P1
			if(woppy_vieBoss>1 and woppy_flagVieBoss==2) then
				woppy_phase=1;
				woppy_flagVieBoss=0;
				RaidNotice_AddMessage(RaidWarningFrame, "PHASE 1", ChatTypeInfo["RAID_WARNING"]);
				print("Phase 1");
			end
			--corruption = /run print(UnitPower("target"))
			
			--Analyse des sorts lancés par immerseus
			if(sourceName=="Immerseus") then
				if(event == "SPELL_CAST_START") then
					print("immerseus casting "..spellName);
					if(spellName == tourbillon) then
						RaidNotice_AddMessage(RaidWarningFrame, "TOURBILLON INC! NE PAS RESTER FACE AU BOSS!", ChatTypeInfo["RAID_WARNING"]);
						RaidNotice_AddMessage(RaidWarningFrame, "EVITER LES TOURBILLONS", ChatTypeInfo["RAID_WARNING"]);
					end
					if(spellName == explosionCaustique) then
						print("Attention de ne pas avoir 2 stack");
					end
				end
			end
			
			--Gestion des debuffs
			if (event == "SPELL_AURA_APPLIED") then
				--Gestion de l'AOE (Area Of Effect (damage))
				if(spellName == projectionSha) then 
					RaidNotice_AddMessage(RaidWarningFrame, "{star}!SORS DE L'AOE!", ChatTypeInfo["RAID_WARNING"]);
				end
				--Gestion du stack explosion caustique
				if(spellName == explosionCaustique) then
					print("Arrghhh explosion caustique!!!");
					--On verifie si l'on possède le debuff (car un membre du raid peut aussi l'avoir)
					for i=1,5 do 
						local name, rank, icon, count, dispelType, duration, expires, caster, isStealable, shouldConsolidate, spellID= UnitDebuff("player",i); --tous les paramètres que retourne la fonction unitdebuff
						if(spellID==143436) then --explosion caustique	
							woppy_flagStack=0; --eviter de spammer un message situer dans la boucle for après cette fonction
							print("Vous avez "..count.." stack de "..name);
							
							----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
							------!Ne fonctionne pas car aura_applied se déclenche seulement si c'est un nouveau debuff. Or pour passer à 2 on possède déjà le debuff (Aura_applied_refresh ne fonctionne pas egalement, ne sait pas pourquoi)->solution boucle for après
							-- if(count>1) then
								-- RaidNotice_AddMessage(RaidWarningFrame, "DANGER! TROP DE STACKS!", ChatTypeInfo["RAID_WARNING"]);
							-- end
							-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
							
							--Si l'on est un soigner ou un dps on doit perdre la menace car le boss met le stack à celui qui l'a aggro
							if(woppy_specRole=="HEALER" or woppy_specRole=="DAMAGER") then 
								RaidNotice_AddMessage(RaidWarningFrame, "PERDEZ LA MENACE", ChatTypeInfo["RAID_WARNING"]);
							end
						end
						
						--si on ne possède pas le stack et que nous sommes tanks on vérifie qui du raid possède le debuff (reprise aggro)
						if(woppy_specRole == "TANK" and spellName == nil) then 
							ScanForDebuff(143436); --explosion caustique
						end
					end
				end
			end--fin "EVENT_AURA_APPLIED"
			
			--tracker pour voir si stack d'explosion caustique > 1 (car pas déclenchée par l'event aura_spell_applied)
			for i=1, 5 do
				local debuff, _, _, stack = UnitDebuff("player", i);
				if(debuff==explosionCaustique) then 
					if(stack~=nil and stack>1 and woppy_flagStack==0) then --verifie que l'on possède une stack pour ne pas générer erreur avec nil 
						woppy_flagStack=1; --evite de spam message
						RaidNotice_AddMessage(RaidWarningFrame, "DANGER! TROP DE STACKS!", ChatTypeInfo["RAID_WARNING"]);
					end
				end
			end
		end --fin de l'event "COMBAT_LOG_EVENT_UNFILTERED"

		--Lorsque l'on sort du combat (soit nous sommes morts, soit avons tué le boss, soit nous nous sommes camouflés)
		if(event == "PLAYER_REGEN_ENABLED") then 
			--reinitialisation des variables en dehors de la fonction
			print("Fin du combat");
			woppy_flag=1;
			woppy_flagVieBoss=0;
			woppy_flagStack=0;
			woppy_phase=1;
			woppy_unitImmerseus=nil;
			woppy_vieBoss=nil;
			woppy_corruptionBoss=nil;
			immerseusFrame:Hide();
		end
	end) --fin de la frame Immerseus "OnEvent"
end	 --fin de la fonction Immerseus



-----------------------2) CHECK SI LE BON BOSS COMBAT POUR LANCER LA STRAT--------------------
	local function CheckCombat()
	inCombatFrame:SetScript("OnUpdate", function(self, event)
			if(UnitAffectingCombat("boss1")) then
				--DEFINITION DU ROLE
				inCombatFrame:Hide();
				woppy_spec = GetSpecialization(); --Si jamais changement de spécialisation entre le moment ou le personnage entre dans le raid et avant de lancer le combat
				woppy_specRole = woppy_spec and select(6, GetSpecializationInfo(woppy_spec)) or "None";--role de la spe, retourne DAMAGER pour dps, HEALER pour heal, et TANK pour tank
				print("Strategie chargée pour "..woppy_specRole);
				StratImmerseus();
			end
		--end
	end)
	end

----------------------1) VERIFICATION DE LA BONNE ZONE-----------------------------------------
--Lorsque l'on entre dans le bon raid, afficher diverses infos...
areaFrame:SetScript("OnEvent", function(self, event, ...)
	local raidNom,_,_,_,_,_,_,raidID = GetInstanceInfo(); --name, type, difficultyIndex, difficulty Name, maxPlayers, dynamicDifficulty, isDynamic, mapID
	if(raidID==1136) then	--Si c'est le raide siège d'orgrimmar..
		RaidNotice_AddMessage(RaidWarningFrame,"Bienvenue Boolkin",ChatTypeInfo["RAID_WARNING"]); --Fonction pour afficher message
		PlaySoundKitID(11466) --Joue un son vous n'êtes pas pret
		print("Bienvenue dans le Siege d'Orgrimmar!");
		print("Test nom de la zone: "..raidNom);
		print("Id du raid: "..raidID);
		woppy_spec = GetSpecialization() --retourne id, name, description, icon, background, role
		woppy_specName = woppy_spec and select(2, GetSpecializationInfo(woppy_spec)) or "None" --Nom de la spe
		woppy_specId = woppy_spec and select(1, GetSpecializationInfo(woppy_spec)) or "None" --ID de la spe
		woppy_specRole = woppy_spec and select(6, GetSpecializationInfo(woppy_spec)) or "None" --role de la spe, retourne DAMAGER pour dps, HEALER pour heal, et TANK pour tank
		print("Votre specialisation actuelle est: "..woppy_specName..". Vous endossez le role de "..woppy_specRole);
		CheckCombat();
	end
end)


--Tests
		-- --SI la spécialisation correspond au role tank: (recuperation de toutes les spe qui tank)
		-- if(woppy_specId==250 or woppy_specId==104 or woppy_specId==268 or woppy_specId==66 or woppy_specId==73) then --chevalier de la mort sang, druide gardien, moine maitre-brasseur, paladin protection, guerrier protection
			-- role="tank";
		-- end
		-- --Role heal
		-- if(woppy_specId==105 or woppy_specId==270 or woppy_specId==65 or woppy_specId==256  or woppy_specId==257 or woppy_specId==264) then --Druide restauration, moine tisse-brume, paladin sacré, pretre discipline, pretre sacré, shaman restauration
			-- role="heal";
		-- end
		-- --Role dps
		-- if(woppy_specId==251 or woppy_specId==252 or woppy_specId==102 or woppy_specId==103 or woppy_specId==253 or woppy_specId==254 or woppy_specId==255 or woppy_specId==62 or woppy_specId==63 or woppy_specId==64 or woppy_specId==269 or woppy_specId==70 or woppy_specId==259 or woppy_specId==260 or woppy_specId==261 or woppy_specId==262 or woppy_specId==263 or woppy_specId==265 or woppy_specId==266 or woppy_specId==267 or woppy_specId==71 or woppy_specId==72) then
			-- role="dps";
		-- end
-- Death Knight 
-- 250 - Blood
-- 251 - Frost
-- 252 - Unholy
-- Druid 
-- 102 - Balance
-- 103 - Feral Combat
-- 104 - Guardian
-- 105 - Restoration
-- Hunter 
-- 253 - Beast Mastery
-- 254 - Marksmanship
-- 255 - Survival
-- Mage 
-- 62 - Arcane
-- 63 - Fire
-- 64 - Frost
-- Monk 
-- 268 - Brewmaster
-- 269 - Windwalker
-- 270 - Mistweaver
-- Paladin 
-- 65 - Holy
-- 66 - Protection
-- 70 - Retribution
-- Priest 
-- 256 Discipline
-- 257 Holy
-- 258 Shadow
-- Rogue 
-- 259 - Assassination
-- 260 - Combat
-- 261 - Subtlety
-- Shaman 
-- 262 - Elemental
-- 263 - Enhancement
-- 264 - Restoration
-- Warlock 
-- 265 - Affliction
-- 266 - Demonology
-- 267 - Destruction
-- Warrior 
-- 71 - Arms
-- 72 - Fury
-- 73 - Protection
